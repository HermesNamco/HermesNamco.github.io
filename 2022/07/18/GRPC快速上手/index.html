<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> GRPC快速上手 · Namco's blog</title><meta name="description" content="GRPC快速上手 - Namco"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://hermesnamco.github.io/atom.xml" title="Namco's blog"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Namco's blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/HermesNamco" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">GRPC快速上手</h1><div class="post-info">2022年7月18日</div><div class="post-content"><blockquote>
<p>引用 <a target="_blank" rel="noopener" href="https://grpc.io/docs/languages/go/basics/">https://grpc.io/docs/languages/go/basics/</a> 内容，记录开发步骤<br>本文使用代码可在 <a target="_blank" rel="noopener" href="https://github.com/HermesNamco/GrpcTest">https://github.com/HermesNamco/GrpcTest</a> 查看</p>
</blockquote>
<h1 id="1-前期准备"><a href="#1-前期准备" class="headerlink" title="1 前期准备"></a>1 前期准备</h1><h4 id="1-1-Go"><a href="#1-1-Go" class="headerlink" title="1.1 Go"></a>1.1 Go</h4><p><a target="_blank" rel="noopener" href="https://go.dev/doc/devel/release">Go</a>发行版安装，推荐安装最新的版本</p>
<h4 id="1-2-Protocol-buffer"><a href="#1-2-Protocol-buffer" class="headerlink" title="1.2 Protocol buffer"></a>1.2 Protocol buffer</h4><p><a target="_blank" rel="noopener" href="https://grpc.io/docs/protoc-installation/">Protocol buffer3</a>安装</p>
<h4 id="1-3-Go工具"><a href="#1-3-Go工具" class="headerlink" title="1.3 Go工具"></a>1.3 Go工具</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28</span><br><span class="line">go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2</span><br><span class="line">export PATH=&quot;$PATH:$(go env GOPATH)/bin&quot;</span><br></pre></td></tr></table></figure>
<p>Go生成桩代码工具安装</p>
<h1 id="2-编写协议"><a href="#2-编写协议" class="headerlink" title="2 编写协议"></a>2 编写协议</h1><h4 id="2-1-protocol3协议文件实例"><a href="#2-1-protocol3协议文件实例" class="headerlink" title="2.1 protocol3协议文件实例"></a>2.1 protocol3协议文件实例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// filename: message.proto</span><br><span class="line"></span><br><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">package grpc.test.message</span><br><span class="line">option go_package=&quot;github.com/HermesNamco/GrpcTest/protocol&quot;;</span><br><span class="line"></span><br><span class="line">service HelloService &#123;</span><br><span class="line">  rpc Hello (HelloReq) returns (HelloRsp) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message HelloReq &#123;</span><br><span class="line">  int32 code = 1;</span><br><span class="line">  string msg = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message HelloRsp &#123;</span><br><span class="line">  string msg = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-生成桩代码"><a href="#2-2-生成桩代码" class="headerlink" title="2.2 生成桩代码"></a>2.2 生成桩代码</h4><p>在协议目录下运行protoc命令，在同目录生成Client Server桩代码，和协议数据结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protoc --go_out=. --go_opt=paths=source_relative \</span><br><span class="line">    --go-grpc_out=. --go-grpc_opt=paths=source_relative \</span><br><span class="line">    ./message.proto</span><br></pre></td></tr></table></figure>

<h1 id="3-RPC服务实现"><a href="#3-RPC服务实现" class="headerlink" title="3 RPC服务实现"></a>3 RPC服务实现</h1><p>在main.go同级目录下,hello_impl.go中实现HelloServiceServer<br>与Trpc不同，Grpc提供了向前兼容选项，详细讨论在<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/65079032/grpc-with-mustembedunimplemented-method">这里</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;context&quot;</span><br><span class="line"></span><br><span class="line">	pb &quot;GrpcTest/protocol&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type HelloImpl struct &#123;</span><br><span class="line">	// 不使用向前兼容，希望在新增rpc方法却没有显示实现时，编译器会报错</span><br><span class="line">	// 如果使用向前兼容，则嵌入pb.UnimplementedHelloServiceServer，新增rpc方法时却没有显示实现时，该结构体提供了默认实现，不会报错</span><br><span class="line">	pb.UnsafeHelloServiceServer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func(impl *HelloImpl)Hello(ctx context.Context, req *pb.HelloReq) (*pb.HelloRsp, error) &#123;</span><br><span class="line">	fmt.Println(req.Code, req.Msg)</span><br><span class="line">	return &amp;pb.HelloRsp&#123;Msg: &quot;Hello&quot;&#125;, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="4-Server调用"><a href="#4-Server调用" class="headerlink" title="4 Server调用"></a>4 Server调用</h1><p>在main.go中注册并启动RpcServer</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;net&quot;</span><br><span class="line"></span><br><span class="line">	grpc &quot;google.golang.org/grpc&quot;</span><br><span class="line"></span><br><span class="line">	pb &quot;github/HermesNamco/GrpcTest/protocol&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	lis, err := net.Listen(&quot;tcp&quot;, fmt.Sprintf(&quot;localhost:%d&quot;, 23333))</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatalf(&quot;failed to listen: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	var opts []grpc.ServerOption</span><br><span class="line">	grpcServer := grpc.NewServer(opts...)</span><br><span class="line">	pb.RegisterHelloServiceServer(grpcServer, &amp;HelloImpl&#123;&#125;)</span><br><span class="line">	grpcServer.Serve(lis)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="5-Client调用"><a href="#5-Client调用" class="headerlink" title="5 Client调用"></a>5 Client调用</h1><p>在不同目录下使用该client，即可于服务端通信，简单验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;context&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">	&quot;google.golang.org/grpc&quot;</span><br><span class="line">	</span><br><span class="line">	pb &quot;github/HermesNamco/GrpcTest/protocol&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	serverAddr := &quot;localhost:23333&quot;</span><br><span class="line">	conn, err := grpc.DialContext(context.TODO(), serverAddr, grpc.WithInsecure())</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		fmt.Println(&quot;Error connect, %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	defer conn.Close()</span><br><span class="line"></span><br><span class="line">	client := pb.NewHelloServiceClient(conn)</span><br><span class="line">	rsp, err := client.Hello(context.TODO(), &amp;pb.HelloReq&#123;Code: 1, Msg: &quot;Hello server&quot;&#125;)</span><br><span class="line">	fmt.Println(rsp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div></main><footer><div class="paginator"><a href="/2022/07/14/go-cache%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2022 <a href="https://hermesnamco.github.io">Namco</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>